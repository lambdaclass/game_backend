<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="configuration/effects.html"><strong aria-hidden="true">1.</strong> Effects</a></li><li class="chapter-item expanded "><a href="configuration/loots.html"><strong aria-hidden="true">2.</strong> Loots</a></li><li class="chapter-item expanded "><a href="configuration/projectiles.html"><strong aria-hidden="true">3.</strong> Projectiles</a></li><li class="chapter-item expanded "><a href="configuration/skills.html"><strong aria-hidden="true">4.</strong> Skills</a></li><li class="chapter-item expanded "><a href="configuration/characters.html"><strong aria-hidden="true">5.</strong> Characters</a></li><li class="chapter-item expanded "><a href="configuration/game.html"><strong aria-hidden="true">6.</strong> Game</a></li><li class="chapter-item expanded "><a href="attributes/players.html"><strong aria-hidden="true">7.</strong> Player attributes</a></li><li class="chapter-item expanded "><a href="attributes/projectiles.html"><strong aria-hidden="true">8.</strong> Projectile attributes</a></li><li class="chapter-item expanded "><a href="architecture/backend_architecture.html"><strong aria-hidden="true">9.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="metrics_and_monitoring/metrics-and-monitoring.html"><strong aria-hidden="true">10.</strong> Metrics and monitoring</a></li><li class="chapter-item expanded "><a href="testing/load_testing/load_testing.html"><strong aria-hidden="true">11.</strong> Load Testing</a></li><li class="chapter-item expanded "><a href="testing/simulating_latency.html"><strong aria-hidden="true">12.</strong> Simulating High Latency</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="effects"><a class="header" href="#effects">Effects</a></h1>
<p>Effects are mostly buffs and debuffs players can have. They will given by skills or loot.</p>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>Configurable fields:</p>
<ul>
<li><code>name</code>: unique name for the effect, this will be referenced by other configurations</li>
<li><code>effect_time_type</code>: This determines how the effect is applied, see below <a href="configuration/effects.html#effect-time-type">&quot;Effect time type&quot;</a></li>
<li><code>is_reversable</code>: Defines if the effect can be reversed when removed from the player (e.g. if it gives 10% more speed it will be removed from the player on removal), see more in <a href="configuration/effects.html#adding-and-removing-effects">&quot;Adding and removing effects&quot;</a></li>
<li><code>player_attributes</code>: Attributes changes that will be applied over the player having this effect</li>
<li><code>projectile_attributes</code>: Attributes changes that will be applied over the projectiles of the player having this effect</li>
<li><code>skill_keys_to_execute</code>: Store skill keys of a character to be executed as long as the effect is applied</li>
</ul>
<h3 id="effect-time-type"><a class="header" href="#effect-time-type">Effect time type</a></h3>
<p>It can be any of:</p>
<ul>
<li><code>Instant</code>: Effect is executed once and removed</li>
<li><code>Duration</code>: Effect is stuck on the player for a duration
<ul>
<li><code>duration_ms</code></li>
</ul>
</li>
<li><code>Permanent</code>: Effect lasts forever and can only be removed by other effects</li>
<li><code>Periodic</code>: Like an Instant, but the effect is applied many times over a period of time
<ul>
<li><code>instant_application</code>: Boolean specifying if first application of effect should happen at instant 0 or not</li>
<li><code>interval_ms</code>: Every X milliseconds the effect will be applied</li>
<li><code>trigger_count</code>: Sets how many times the effect will be applied</li>
</ul>
</li>
</ul>
<p>For <code>Duration</code> and <code>Periodic</code> the configuration expects a JSON object with a <code>type</code> field corresponding to the type</p>
<pre><code>{
  &quot;type&quot;: &quot;Duration&quot;,
  &quot;duration_ms&quot;: 1234
}

{
  &quot;type&quot;: &quot;Periodic&quot;,
  &quot;instant_application&quot;: false
  &quot;interval_ms&quot;: 500
  &quot;trigger_count&quot;: 4
}
</code></pre>
<h3 id="attributes-changes"><a class="header" href="#attributes-changes">Attributes changes</a></h3>
<p>To learn more about attributes see the <a href="configuration/../attributes/attributes.html">Attributes</a> section, below you can find quick links to the documentation for each entity with changeable attributes</p>
<ul>
<li><a href="configuration/../attributes/players.html">Player attributes</a></li>
<li><a href="configuration/">Projectile attributes</a></li>
</ul>
<p>An attribute change is comprised of the following:</p>
<ul>
<li><code>attribute</code>: Attribute to modify, the exact values allowed depend on the entity you are modifying. If the attribute is a map you can either provide the attribute to modify all or use <code>.</code> syntax to only target a key in it</li>
<li><code>modifier</code>: Determines how <code>value</code> interacts with the current value of the attribute, it can be one of
<ul>
<li><code>additive</code>: Given value is added to current value</li>
<li><code>multiplicative</code>: Given value is multiplied to current value</li>
<li><code>override</code>: Given value is set as the attribute value</li>
</ul>
</li>
<li><code>value</code>: The value we are using for the change</li>
</ul>
<pre><code># Heal by 20%
{
  &quot;attribute&quot;: &quot;Health&quot;,
  &quot;modifier&quot;: multiplicative,
  &quot;value&quot;: 1.2
}
</code></pre>
<h3 id="example"><a class="header" href="#example">Example</a></h3>
<p>Examples of the JSON defining effects</p>
<pre><code>[
  {
    &quot;name&quot;: &quot;gain_health_10_3s&quot;
    &quot;is_reversable&quot;: false,
    &quot;effect_time_type&quot;: {
      &quot;type&quot;: &quot;Periodic&quot;,
      &quot;instant_application&quot;: false
      &quot;interval_ms&quot;: 1000
      &quot;trigger_count&quot;: 3
    },
    &quot;player_attributes: [
      {
        &quot;attribute&quot;: &quot;Health&quot;,
        &quot;modifier&quot;: additive,
        &quot;value&quot;: 10
      }
    ],
    &quot;projectile_attributes&quot;: [],
    &quot;skills_keys_to_execute&quot;: []
  },
  {
    &quot;name&quot;: &quot;gigantify&quot;
    &quot;effect_time_type&quot;: {
      &quot;type&quot;: &quot;Duration&quot;,
      &quot;duration_ms&quot;: 5000
    },
    &quot;player_attributes: [
      {
        &quot;attribute&quot;: &quot;Size&quot;,
        &quot;modifier&quot;: multiplicative,
        &quot;value&quot;: 1.5
      },
      {
        &quot;attribute&quot;: &quot;Damage&quot;,
        &quot;modifier&quot;: additive,
        &quot;value&quot;: 20
      }
    ],
    &quot;projectile_attributes&quot;: [],
    &quot;skills_keys_to_execute&quot;: [&quot;1&quot;]
  }
]
</code></pre>
<h3 id="adding-and-removing-effects"><a class="header" href="#adding-and-removing-effects">Adding and removing effects</a></h3>
<p>Some effects result in an increase in a player's attributes. When the effect's duration expires, we need to revert the changes made to the attribute. To address this, we've implemented a revert_attribute function that undoes the effect's modifications.</p>
<p>However, caution is required! With the possibility of applying both Additive and Multiplicative effects, there is a risk of not obtaining the correct attribute values when performing a reversal.</p>
<p>Furthermore, we haven't accounted for the ability to reverse an Override effect since we don't store the previous value.</p>
<p>Other effects trigger the action of executing a skill. That skill will be executed as long as the effect is active, accordingly to its effect_time_type.</p>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<pre><code>These example is a supposition.

Suppose a player has an initial speed of 100 units. The player acquires boots that boost their speed by 50% (multiplicative (*1.5)). Then, they receive a leap, which reduces their speed by 10 units (additive (-10)). After these two events, the player has a speed of 140 units.

If we reverse the effects in the following order, we will return to the original value of 100:

1. Add 10 units to the speed value (reverse additive + 10).
2. Divide the value by 1.5 (reverse multiplicative / 1.5).

However, if we change the order as follows:

1. Divide the value by 1.5 (reverse multiplicative / 1.5).
2. Add 10 units to the speed value (reverse additive + 10).

We will obtain the wrong value of 103.

An example of an effect that executes a skill could be an Effect with effect_time_type: {&quot;type&quot;: &quot;Periodic&quot;, &quot;interval_ms&quot;: 1000, &quot;trigger_count&quot;: 3} and &quot;skills_to_execute&quot;: [&quot;1&quot;].

With the above configuration, the player's character will execute the character skill number &quot;1&quot; 3 times in intervals of 1000 ms, when the effect is active.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="loots"><a class="header" href="#loots">Loots</a></h1>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>Configurable fields:</p>
<ul>
<li><code>name</code>: unique name for the loot, this will be referenced by other configurations</li>
<li><code>size</code>: radius size of the loot</li>
<li><code>pickup_mechanic</code>: Defines how the loot is picked up, see <a href="configuration/loots.html#pickup-mechanics">&quot;Pickup mechanics&quot;</a></li>
<li><code>effects</code>: List of effects the loot will give out</li>
</ul>
<h2 id="pickup-mechanics"><a class="header" href="#pickup-mechanics">Pickup mechanics</a></h2>
<ul>
<li><code>CollisionToInventory</code>: On colliding with the loot it will be stored in the user inventory if there is space</li>
<li><code>CollisionUse</code>: On colliding with the loot it will be applied to the colliding player</li>
</ul>
<h3 id="example-1"><a class="header" href="#example-1">Example</a></h3>
<pre><code>[
  {
    &quot;name&quot;: &quot;giant&quot;
    &quot;size&quot;: 100,
    &quot;effects&quot;: [&quot;gigantify&quot;]
  },
  {
    &quot;name&quot;: &quot;heal&quot;
    &quot;size&quot;: 100,
    &quot;effects&quot;: [&quot;gain_health_10_3s&quot;]
  }
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="projectiles"><a class="header" href="#projectiles">Projectiles</a></h1>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<p>Configurable fields:</p>
<ul>
<li><code>name</code>: Unique name for the projectile, this will be referenced by other configurations</li>
<li><code>base_damage</code>: Damage done by the projectile on collision</li>
<li><code>base_speed</code>: Travel speed of the projectile</li>
<li><code>base_size</code>: Size of the projectile for collision math</li>
<li><code>remove_on_collision</code>: Determines if the projectile is removed from game after colliding with a player, default is <code>true</code></li>
<li><code>on_hit_effects</code>: Effects given to target on collision</li>
<li><code>duration_ms</code>: Defines how long in milliseconds the projectile can exist</li>
<li><code>max_distance</code>: Defines the maximum distance the projectile can travel</li>
</ul>
<p><strong>Note:</strong> If both <code>duration_ms</code> and <code>max_distance</code> are specified it will trigger on whichever it reaches first, it won't wait for both</p>
<h3 id="example-2"><a class="header" href="#example-2">Example</a></h3>
<p>Some example configurations</p>
<pre><code>[
  {
    &quot;name&quot;: &quot;some_projectile&quot;,
    &quot;base_damage&quot;: 10,
    &quot;base_speed&quot;: 123,
    &quot;base_size&quot;: 50,
    &quot;remove_on_collision&quot;: true,
    &quot;on_hit_effects&quot;: []
  },
  {
    &quot;name&quot;: &quot;poison_dart&quot;
    &quot;base_damage&quot;: 25,
    &quot;base_speed&quot;: 70,
    &quot;base_size&quot;: 50,
    &quot;on_hit_effect&quot;: [&quot;poison&quot;],
    &quot;max_distance&quot;: 1200
  },
  {
    &quot;name&quot;: &quot;poison_dart&quot;
    &quot;base_damage&quot;: 0,
    &quot;base_speed&quot;: 120,
    &quot;base_size&quot;: 50,
    &quot;on_hit_effect&quot;: [&quot;freeze&quot;],
    &quot;duration_ms&quot;: 2000
  },
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="skills"><a class="header" href="#skills">Skills</a></h1>
<h2 id="configuration-3"><a class="header" href="#configuration-3">Configuration</a></h2>
<ul>
<li><code>name</code>: Unique name for the skill, this will be referenced by other configurations</li>
<li><code>cooldown_ms</code>: Time that needs to elapse before the skill recharges</li>
<li><code>execution_duration_ms</code>: Time in milliseconds it takes to perform the skill, player will be unable to move or attack in the meantime</li>
<li><code>is_passive</code>: Marks the skill as a passive skill, this means it can't be triggered. Instead it will trigger on player spawn, so only <code>GiveEffect</code> makes sense for it</li>
<li><code>mechanics</code>: Core mechanic of the skill (e.g hit, shoot, etc)</li>
</ul>
<h3 id="mechanics"><a class="header" href="#mechanics">Mechanics</a></h3>
<p>These are the mechanics so far. Every mechanic will add a configuration field with the same name, which is a nested object with configuration attributes specific for it</p>
<ul>
<li><code>GiveEffect</code>: This makes the skill give a certain effect
<ul>
<li><code>effects</code>: List of effects given</li>
</ul>
</li>
<li><code>Hit</code>: Player will hit all things in area of target
<ul>
<li><code>damage</code>: Damage done to targets</li>
<li><code>range</code>: Up to how far away can things be hit</li>
<li><code>cone_angle</code>: Defines how the cone of hit is generated, see <a href="configuration/skills.html#explaining-cone_angle">Explaining cone_angle</a></li>
<li><code>on_hit_effects</code>: Effects given to targets hit by skill</li>
</ul>
</li>
<li><code>SimpleShoot</code>: Player will shoot a projectile
<ul>
<li><code>projectile</code>: Projectile to shoot</li>
</ul>
</li>
<li><code>MultiShoot</code>: Player will shoot multiple shots of a projectile
<ul>
<li><code>projectile</code>: Projectile to shoot</li>
<li><code>count</code>: How many projectiles will be shot</li>
<li><code>cone_angle</code>: Defines how wide is the angle to spread the projectiles on, see <a href="configuration/skills.html#explaining-cone_angle">Explaining cone_angle</a></li>
</ul>
</li>
<li><code>MoveToTarget</code>: Player will be moved to target position
<ul>
<li><code>duration_ms</code>: How long it takes to move the player, 0 means instantly</li>
<li><code>max_range</code>: Maximum distance allowed to move, if target is beyond this limit movement will be capped to this point</li>
</ul>
</li>
</ul>
<h3 id="explaining-cone_angle"><a class="header" href="#explaining-cone_angle">Explaining cone_angle</a></h3>
<p><code>cone_angle</code> is the angle to define a cone coming from a player, this is mostly used to define an area from where targets can be selected.</p>
<p>This angle takes the player orientation as angle 0, so for simplicit let's say orientation is 0 as well. As the angle increases the cone starts to open, this cone is formed so if the angle is 90˚ doesn't mean it goes from orientation 0 to 90, it actually means it goes from orientation 45 to -45. The cone opens equally on both ways. Something like this</p>
<pre><code>o o o o x     Legend:
o o o x x       `&gt;` is the player, it is looking to the right (east)
o o &gt; x x       `o` represents spaces not selected for targetting
o o o x x       `x` represents spaces selected for targetting
o o o o x
</code></pre>
<p>This means that an angle of 180˚ would pick everything from the sides to the front of the player, but not the back. Something like this</p>
<pre><code>o o x x x     Legend:
o o x x x       `&gt;` is the player, it is looking to the right (east)
o o &gt; x x       `o` represents spaces not selected for targetting
o o x x x       `x` represents spaces selected for targetting
o o x x x
</code></pre>
<h2 id="configuration-4"><a class="header" href="#configuration-4">Configuration</a></h2>
<p>Some example configurations</p>
<pre><code>[
  {
    &quot;name&quot;: &quot;rage&quot;
    &quot;cooldown_ms&quot;: 10000,
    &quot;is_passive&quot;: false,
    &quot;mechanics&quot;: [
      {
        &quot;GiveEffect&quot;: {
          &quot;effects&quot;: [&quot;damage_increase_45&quot;, &quot;speed_increase_25&quot;]
        }
      }
    ]
  },
  {
    &quot;name&quot;: &quot;5_shot&quot;
    &quot;cooldown_ms&quot;: 4500,
    &quot;is_passive&quot;: false,
    &quot;mechanics&quot;: [
      {
        &quot;Shoot&quot;: {
          &quot;projectile&quot;: &quot;some_projectile&quot;
          &quot;multishot_count&quot;: 5
          &quot;multishot_cone_angle&quot;: 90
        }
      }
    ]
  },
  {
    &quot;name&quot;: &quot;leap&quot;
    &quot;cooldown_ms&quot;: 6000,
    &quot;is_passive&quot;: false,
    &quot;mechanics&quot;: [
      {
        &quot;MoveToTarget&quot;: {
          &quot;duration_ms&quot;: 1000
          &quot;max_range&quot;: 500
        }
      },
      &quot;Hit&quot;: {
        &quot;damage&quot;: 25
        &quot;range&quot;: 100
        &quot;cone_angle&quot;: 360
      }
    ],
  }
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="characters"><a class="header" href="#characters">Characters</a></h1>
<h2 id="configuration-5"><a class="header" href="#configuration-5">Configuration</a></h2>
<p>Configurable fields:</p>
<ul>
<li><code>name</code>: Unique name of the character, this will be referenced by other configurations</li>
<li><code>active</code>: Can the character be picked</li>
<li><code>base_speed</code>: Base speed of the character</li>
<li><code>base_size</code>: Size of the character for collision math</li>
<li><code>base_health</code>: Base health of the character</li>
<li><code>skills</code>: This is a map of integer (as string) to skills, the integers represent the id and ordering of skills for calling them</li>
<li><code>max_inventory_size</code>: Maximum amount of loots that the character can hold in their inventory</li>
</ul>
<h3 id="example-3"><a class="header" href="#example-3">Example</a></h3>
<pre><code>[
  {
    &quot;name&quot;: &quot;H4ck&quot;
    &quot;active&quot;: true,
    &quot;base_speed&quot;: 25,
    &quot;base_size&quot;: 80,
    &quot;base_health&quot;: 8000,
    &quot;skills&quot;: {
      &quot;1&quot;: &quot;Slingshot&quot;,
      &quot;2&quot;: &quot;Multishot&quot;,
    }

  }
]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="game"><a class="header" href="#game">Game</a></h1>
<p>This is the meta configuration for the game, not for a particular thing in the game</p>
<h2 id="configuration-6"><a class="header" href="#configuration-6">Configuration</a></h2>
<ul>
<li><code>width</code>: Defines the width of the playing area</li>
<li><code>height</code>: Defines the length of the playing area</li>
<li><code>zone_starting_radius</code>: Radius of the playable zone. The zone is an area in the map where effects are applied to players not in it</li>
<li><code>zone_modifications</code>: This is attribute is a list of modifications to perform to the playable zone in the map. For the specifics see below <a href="configuration/game.html#zone-modification">&quot;Zone modification&quot;</a></li>
<li><code>loot_interval_ms</code>: If present, interval in milliseconds for spawning loot crates</li>
<li><code>auto_aim_max_distance</code>: Determines the max distance to auto aim</li>
<li><code>initial_positions</code>: The predefined positions for players to spawn in the map.</li>
</ul>
<h3 id="zone-modification"><a class="header" href="#zone-modification">Zone modification</a></h3>
<p>As mentioned this attribute is composed of a list of &quot;modifications&quot;. These modifications are processed in order and once the <code>duration_ms</code> of the current one is reached the runner will move on to the next one and apply changes based on those rules. If you don't wish to have any modifications you can set an empty list</p>
<p>This &quot;modifications&quot; are compose of the following fields</p>
<ul>
<li><code>duration_ms</code>: Duration the modification should be applied for</li>
<li><code>modification</code>: Defines how to modify the playable zone radius, similar to attributes changes it has a <code>modifier</code> and <code>value</code> fields</li>
<li><code>interval_ms</code>: Every X milliseconds the modification is applied</li>
<li><code>min_radius</code>: Mininum radius for the playable zone, how small can the playable zone get</li>
<li><code>max_radius</code>: Max radius for the playable zone, how big can the playable zone get</li>
<li><code>outside_radius_effects</code>: Effects given when a player is outside the playable zone</li>
</ul>
<h3 id="example-4"><a class="header" href="#example-4">Example</a></h3>
<pre><code>{
  &quot;width&quot;: 10000,
  &quot;height&quot;: 10000,
  &quot;zone_starting_radius&quot;: 10000,
  &quot;zone_modification&quot;: [
    {
      &quot;duration_ms&quot;: 1000,
      &quot;modification&quot;: {
        &quot;modifier&quot;: &quot;Multiplicative&quot;,
        &quot;value&quot;: 0.9,
      },
      &quot;interval_ms&quot;: 500,
      &quot;trigger_count&quot;: 5000,
      &quot;min_radius&quot;: 1800,
      &quot;max_radius&quot;: 10000,
      &quot;outside_radius_effects&quot;: [damage_outside_area],
    }
  ]
  &quot;loot_interval_ms&quot;: 7000,
  &quot;auto_aim_max_distance&quot;: 2000,
  &quot;initial_positions&quot;: [
      {
        &quot;x&quot;: -4500,
        &quot;y&quot;: 1500
      },
      {
        &quot;x&quot;: -3000,
        &quot;y&quot;: 4000
      },
      {
        &quot;x&quot;: 0,
        &quot;y&quot;: 2000
      }
  ]
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="player-attributes"><a class="header" href="#player-attributes">Player attributes</a></h1>
<h2 id="non-changeable-attributes"><a class="header" href="#non-changeable-attributes">Non-changeable attributes</a></h2>
<ul>
<li><code>id</code>: unique identifier for the player</li>
<li><code>character</code>: character player is using</li>
<li><code>status</code>: represents the player state (e.g. alive, dead, etc)</li>
<li><code>kill_count</code>: number of kills by the player</li>
<li><code>death_count</code>: number of times a player has died</li>
<li><code>effects</code>: List of effects affecting the player</li>
<li><code>position</code>: Current position</li>
<li><code>direction</code>: angle where the player is facing</li>
<li><code>actions</code>: Actions taken by the player since the last world tick</li>
<li><code>action_duration_ms</code>: Time in milliseconds remaining before a player can do another action, usually only skills add to this value (e.g. moving is free)</li>
<li><code>inventory</code>: List of loots that the player is holding and can activate</li>
</ul>
<h2 id="changeable-attributes"><a class="header" href="#changeable-attributes">Changeable attributes</a></h2>
<ul>
<li><code>health</code>: current health of the player</li>
<li><code>cooldowns</code>: Map containing the remaining cooldown for each skill, if skill is not present it has no pending cooldown. To change this attribute you can either say <code>cooldown</code> to affect all of them or use <code>.</code> syntax to target a specific key (e.g <code>cooldown.1</code> to target skill <code>1</code>)</li>
<li><code>size</code>: Size for the player model and collision math</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="projectile-attributes"><a class="header" href="#projectile-attributes">Projectile attributes</a></h1>
<h2 id="non-changeable-attributes-1"><a class="header" href="#non-changeable-attributes-1">Non-changeable attributes</a></h2>
<ul>
<li><code>id</code>: Unique identifier for the projectile</li>
<li><code>name</code>: Name of the projectile config used to instantiate</li>
<li><code>character</code>: Character projectile is using</li>
<li><code>on_hit_effects</code>: Effects given to target on collision</li>
<li><code>position</code>: Current position</li>
<li><code>direction</code>: Angle where the projectile is facing</li>
<li><code>creator_player_id</code>: ID of the player that created the projectile</li>
<li><code>duration_ms</code>: Time remaining on the projectile</li>
<li><code>distance</code>: Distance remaining on the projectile</li>
</ul>
<h2 id="changeable-attributes-1"><a class="header" href="#changeable-attributes-1">Changeable attributes</a></h2>
<ul>
<li><code>damage</code>: Damage done to players on collision</li>
<li><code>speed</code>: Speed of the projectile</li>
<li><code>size</code>: Size for the projectile model and collision math</li>
<li><code>remove_on_collision</code>: Determines if the projectile is removed from game after colliding with a player</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend-architecture"><a class="header" href="#backend-architecture">Backend Architecture</a></h1>
<p>In this document we go over how the backend is structured. Currently, it serves two related but distinct purposes:</p>
<ul>
<li>It provides a matchmaking functionality, where players join lobbies with other players hoping to start a game or create their own so others can join.</li>
<li>Once a game starts, it acts as the authoritative server for it. It receives players' actions, updates the game state according to the rules of the game, then sends it back to players. We'll call this the <em>gameplay</em> functionality.</li>
</ul>
<p>Having a p2p solution is not possible due to potential cheats and due to connectivity problems between cellphones.
The server is responsible of coordinating state between clients and banning cheaters.</p>
<p>The architecture of the server should be as simple as possible. </p>
<ul>
<li>1 process per player</li>
<li>1 game_state process</li>
<li>N+1 processes in total with N being the number of players</li>
</ul>
<h2 id="round"><a class="header" href="#round">Round</a></h2>
<ol>
<li>Clients send messages to the <code>game_state</code> process</li>
<li>Game state processes all messages in order</li>
<li>The <code>tick</code>, which is the clock of the game, is updated and the game state process sends a small delta update to all the players with the changes that were realized during the tick.</li>
</ol>
<blockquote>
<p>Most of the work is done during 3 where collision is detected, powers get consumed, creates get spawned or assigned to a client, damage and death are resolved.</p>
</blockquote>
<ol start="4">
<li>Go to 1.</li>
</ol>
<h2 id="api"><a class="header" href="#api">API</a></h2>
<p>We aim for the API provided to clients during a game to be as simple as possible:</p>
<ul>
<li>move(joystick_values): Allows a player to move through the board by providing joystick values corresponding to the direction of movement.</li>
<li>basic_attack(joystick_values): Takes joystick values to determine the direction of the attack.</li>
<li>skill(skill_name, joystick_values): Accepts joystick values for skill direction along with the skill name.</li>
<li>refresh: Used to request the entire game state.</li>
</ul>
<p>Additionally, the server can communicate various messages to the clients:</p>
<ul>
<li>game_start: Indicates the start of the game.</li>
<li>game_end: Signals the end of the game.</li>
<li>state: Represents the differences between two states.</li>
<li>game_state: Contains all the information about the game.</li>
<li>ping: Used to inquire about the server's ping.</li>
</ul>
<h2 id="matchmaking"><a class="header" href="#matchmaking">Matchmaking</a></h2>
<p>For matchmaking to work, players should be able to:</p>
<ul>
<li>Join an existing lobby.</li>
<li>Create a lobby if no other exists.</li>
<li>Start the game once the lobby is full.</li>
</ul>
<p>All matchmaking sessions are spawned by a <code>DynamicSupervisor</code> called <code>MatchingSupervisor</code>. When a player creates a lobby, this supervisor starts a new child <code>MatchingSession</code> process. This is the process that will both handle the logic and hold all of the state for that lobby. Right now, that's just a list of the current players in the lobby, along with the ability to add/remove players and start the game.</p>
<p>Inside a lobby, when the game starts, the lobby process uses <a href="https://hexdocs.pm/phoenix_pubsub/Phoenix.PubSub.html">Phoenix PubSub</a> to broadcast a message saying that the game has started; then it terminates. We'll go into it later, but the idea is that the <em>gameplay</em> part of the server will pick up this message and start the game from there.</p>
<p>Every lobby has a unique <code>ID</code>, which we call the <code>session_id</code> throughout the code. This id is simply the erlang <code>PID</code> of the lobby process with an encoding on top to make it human readable. This way players can pass it around to their friends to join their lobbies.</p>
<h3 id="create-lobby"><a class="header" href="#create-lobby">Create lobby</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Player1
    participant Server
    participant MatchingSupervisor
    participant MatchingSession
    Player1-&gt;&gt;Server: Create lobby
    Server-&gt;&gt;MatchingSupervisor: Create matchmaking session
    MatchingSupervisor-&gt;&gt;MatchingSession: Start child
    MatchingSession-&gt;&gt;MatchingSupervisor: PID
    MatchingSupervisor-&gt;&gt;Player1: Session ID (Encoded PID)
</code></pre>
<h3 id="join-game"><a class="header" href="#join-game">Join game</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Player2
    participant Server
    participant MatchingSupervisor
    participant MatchingSession
    Player2-&gt;&gt;Server: List lobbies
    Server-&gt;&gt;MatchingSupervisor: list_session_ids()
    MatchingSupervisor-&gt;&gt;Player2: [TKSvPBC9iiXaKrqxigozgYLja71X2s9txQPPqDznj, ...]
    Player2-&gt;&gt;Server: Join Lobby TKSvPBC9iiXaKrqxigozgYLja71X2s9txQPPqDznj
    Server-&gt;&gt;MatchingSession: call(matchmaking_session_pid, :add_player, player)
    MatchingSession-&gt;&gt;Server: OK
    Server-&gt;&gt;Player2: Lobby joined
</code></pre>
<h3 id="start-game"><a class="header" href="#start-game">Start game</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    Player1-&gt;&gt;Server: Start game TKSvPBC9iiXaKrqxigozgYLja71X2s9txQPPqDznj
    Server-&gt;&gt;MatchingSession: call(matchmaking_session_pid, :start_game)
    MatchingSession-&gt;&gt;MatchingSession: Broadcast {:game_started, matchmaking_session_id, players}
    MatchingSession-&gt;&gt;MatchingSession: Terminate
</code></pre>
<h2 id="gameplay"><a class="header" href="#gameplay">Gameplay</a></h2>
<p>When a game starts, two things happen:</p>
<ul>
<li>A game session is spawned by a <code>DynamicSupervisor</code> called <code>Engine</code>.  This <code>Engine</code> starts a new child <code>Runner</code> process, which holds the entire game's state and the logic to update it according to the players' actions. The PID of this <code>Runner</code> is encoded in a human friendly format and called the <code>game_session_id</code>.</li>
<li>Every player connects to the game through websocket under the <code>/play/:game_session_id</code> path. Each player's connection is handled by a separate <a href="https://ninenines.eu/docs/en/cowboy/2.6/manual/cowboy_websocket/">cowboy websocket</a> process, defined in the <code>PlayWebSocket</code> module. On startup, the process saves the runner's PID so it can communicate with it. Inside the game, a player is the same as a websocket connection.</li>
</ul>
<p>Let's go over the main gameplay flow. Let's say <code>player_1</code> wants to move to the right one square. To do this, they send a <code>JSON</code> frame over the socket that looks like this:</p>
<pre><code class="language-json">{&quot;action&quot;: &quot;move_with_joystick&quot;, &quot;value&quot;: &quot;{angle}&quot;}
</code></pre>
<p>The corresponding <code>PlayWebSocket</code> process picks it up, decodes it, then sends a message to the <code>Runner</code> with the player's action like this:</p>
<pre><code class="language-elixir">GenServer.cast(runner_pid, {:move, user_id, action})
</code></pre>
<p>The <code>Runner</code>'s appropriate handler eventually picks up this message, which in this case looks like this:</p>
<pre><code class="language-elixir">  def handle_cast({:move, user_id, %ActionOk{value: value, timestamp: timestamp}}, state) do
    angle =
      case Nx.atan2(value.y, value.x) |&gt; Nx.multiply(Nx.divide(180.0, Nx.Constants.pi())) |&gt; Nx.to_number() do
        pos_degree when pos_degree &gt;= 0 -&gt; pos_degree
        neg_degree -&gt; neg_degree + 360
      end

    player_id = state.user_to_player[user_id]
    game_state = LambdaGameEngine.move_player(state.game_state, player_id, angle)

    state =
      Map.put(state, :game_state, game_state)
      |&gt; put_in([:player_timestamps, player_id], timestamp)

    {:noreply, state}
  end
</code></pre>
<p>Every action handler updates the game state accordingly. We're managing game
updates through a tick rate. The runner sends a message to itself every 30ms and
does a broadcast of the new state. Currently, this is being done on the handler
that matches with <code>:update_state</code>.</p>
<p>You'll notice the <code>init</code> function on the <code>PlayWebSocket</code> process does (among other things) the following:</p>
<pre><code class="language-elixir">:ok = Phoenix.PubSub.subscribe(DarkWorldsServer.PubSub, &quot;game_play_#{game_id}&quot;)
</code></pre>
<p>This allows the socket processes to receive state updates they can then relay to the player.</p>
<p>Below are two diagrams summarizing the whole flow.</p>
<h3 id="new-game"><a class="header" href="#new-game">New Game</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Player (Unity Client)
    participant Server
    participant Engine
    participant Runner
    participant PlayerWebSocket
    Player (Unity Client)-&gt;&gt;Server: Start Game
    Server-&gt;&gt;Engine: Start Runner
    Engine-&gt;&gt;Runner: Spawn child
    Runner-&gt;&gt;Engine: Runner PID
    Engine-&gt;&gt;Server: PID
    Server-&gt;&gt;Player (Unity Client): game_session_id
    Player (Unity Client)-&gt;&gt;Server: ws://.../play/:game_session_id
    Server-&gt;&gt;PlayerWebSocket: Handle connection
    PlayerWebSocket-&gt;&gt;PlayerWebSocket: PubSub.subscribe( game_session_topic)
</code></pre>
<h3 id="gameplay-1"><a class="header" href="#gameplay-1">Gameplay</a></h3>
<pre><code class="language-mermaid">sequenceDiagram
    participant Player (Unity Client)
    participant PlayerWebSocket
    participant Runner
    Player (Unity Client)-&gt;&gt;PlayerWebSocket: {&quot;action&quot;: &quot;move&quot;, &quot;value&quot;: &quot;right&quot;}
    PlayerWebSocket-&gt;&gt;Runner: cast(runner_pid, {:play, player_id, {:move, :right}})
    Runner-&gt;&gt;Runner: Move player (update internal state)
    Runner-&gt;&gt;PlayerWebSocket: Broadcast(game_session_topic, {:game_update, new_state})
    PlayerWebSocket-&gt;&gt;Player (Unity Client): new_state
</code></pre>
<h1 id="commentsomissions"><a class="header" href="#commentsomissions">Comments/Omissions</a></h1>
<h2 id="state-management-and-rust-nifs"><a class="header" href="#state-management-and-rust-nifs">State management and Rust NIFs</a></h2>
<p>In the architecture walkthrough above, we glossed over how the game state is handled. Currently, it consists of two things:</p>
<ul>
<li>A list of players, each of which has an <code>id</code>, a position, and a health value.</li>
<li>A <code>board</code>, which is just a matrix indicating what each cell on the map contains (whether it's empty, has a player in it, etc).</li>
</ul>
<p>This state is kept inside the <code>Runner</code> process, but <em>state transitions</em> (players moving, attacking, etc) are computed in Rust. To call Rust code from Elixir we use <a href="https://github.com/rusterlium/rustler">Rustler</a>, which allows us to write <code>NIF</code>s; a way to call low level performant code inside the Erlang VM. You can read more about them <a href="https://www.erlang.org/doc/tutorial/nif.html">here</a> and <a href="https://www.erlang.org/doc/man/erl_nif.html">here</a>.</p>
<p>All the Rust game state code is located inside the <code>native/gamestate</code> directory. The functions exposed to Elixir are all in the <code>lib.rs</code> file. Here's the function that we call to move players around the map:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[rustler::nif(schedule = &quot;DirtyCpu&quot;)]
fn move_player(game: GameState, player_id: u64, direction: Direction) -&gt; GameState {
    let mut game_2 = game;
    game_2.move_player(player_id, direction);
    game_2
}
<span class="boring">}
</span></code></pre></pre>
<p>The associated Elixir function is inside the <code>Engine.Game</code> module:</p>
<pre><code class="language-elixir">def move_player(_a, _b, _c), do: :erlang.nif_error(:nif_not_loaded)
</code></pre>
<p>The magic that makes this call Rust underneath is all inside this <code>use</code> declaration</p>
<pre><code class="language-elixir">use Rustler, otp_app: :dark_worlds_server, crate: &quot;gamestate&quot;
</code></pre>
<p>Every Rust Struct has a corresponding Elixir struct that it maps to; calling the Elixir functions is transparent to someone using the API.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="metrics-and-monitoring"><a class="header" href="#metrics-and-monitoring">Metrics and monitoring</a></h1>
<h2 id="available-custom-metrics"><a class="header" href="#available-custom-metrics">Available custom metrics</a></h2>
<p>The following metrics are available in the APM Metric Explorer section in NewRelic</p>
<ul>
<li><code>GameBackend/GameTickExecutionTimeMs</code>: Timing in milliseconds for calling <code>GameBackend.game_tick/2</code></li>
</ul>
<p>This metrics are only visible by selecting them as <code>COUNT</code></p>
<ul>
<li><code>GameBackend/TotalPlayers</code>: Count of players added across all games</li>
<li><code>GameBackend/TotalBots</code>: Count of bots added across all games</li>
<li><code>GameBackend/TotalGames</code>: Count of game gen_servers currently alive</li>
<li><code>GameBackend/TotalGameWebSockets</code>: Count of websockets connected for games</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="load-testing-guide"><a class="header" href="#load-testing-guide">Load Testing guide</a></h1>
<p>The goal of load testing is to simulate a real scenario where there
are a lot of players in one server, our current goal is 1000 players by server.</p>
<p>Our current methodology is to use 2 servers to load test:</p>
<ul>
<li>The game server: where the game's server is actually running.</li>
<li>The load test client: sends requests to the game server, we 
want a dedicated load test client to avoid consumer network
and hardware limitations.</li>
</ul>
<p>Some things to keep in mind about load tests:</p>
<ul>
<li>Always write a report, and every report must go to:
server/load_test/reports/your_report.md, this is important 
to keep track of possible performance regressions.</li>
<li>Always write down the specs + OS + config from where you're running the tests.
For example, did you change linux's governor settings? Write it down.
Did you test any BEAM VM flag? Keep a record of it.</li>
<li>Write down every code snippet that you've used, be it Elixir, Rust or bash commands,
if you think it's obvious, write it down just in case.</li>
<li>Track records of the parameters you've used for the tests, eg: Player Amount,
were there bots enabled? etc.</li>
<li>Use text or pictures for reports, videos only if there are UX (i.e. gameplay) issues.</li>
<li>Use multiple sources of truth and data, like htop, New Relic, erlang's etop/fprop.</li>
<li>Feel free to experiment a bit, certain VM flags can improve or hinder performance,
if you find improvements.</li>
<li>It's important for load tests to be reproducible.</li>
</ul>
<h3 id="setup"><a class="header" href="#setup">Setup</a></h3>
<p>I recommend you add each server ip to your ~/.ssh/config file to avoid confusions, like this:
First, open a terminal and run: </p>
<pre><code class="language-bash"> open ~/.ssh/config
</code></pre>
<p>And paste this:</p>
<pre><code class="language-conf">Host myrra_load_test_client
  Hostname client_ip

Host myrra_load_test_server
  Hostname game_ip
</code></pre>
<h3 id="game-server-setup"><a class="header" href="#game-server-setup">Game Server Setup</a></h3>
<ol>
<li>
<p>Check you can log into it with ssh: </p>
<pre><code class="language-sh">ssh myuser@myrra_load_test_server
</code></pre>
</li>
<li>
<p>If it's not already there exit, copy the script on this repo under
<code>game_backend/load_test/setup_game_server.sh</code> it clones the game server and compiles it:</p>
<pre><code class="language-sh">scp /path_go_game_backend/game_backend/load_test/setup_game_server.sh myrra_load_test_server:/user/setup_game_server.sh
</code></pre>
<p>Then relog (step 1) and relog into the server 
<code>setup_game_server</code> can also take a branch name as an argument. So if you want to run the load test on an specific branch, you can instead do:</p>
<pre><code class="language-sh">chmod +x ./setup_game_server.sh &amp;&amp; ./setup_game_server.sh &lt;BRANCH_NAME_TO_TEST&gt;
</code></pre>
</li>
<li>
<p>Now you can start the game server with: </p>
</li>
</ol>
<pre><code class="language-sh">export $(cat .env | xargs) &amp;&amp; cd game_backend &amp;&amp; MIX_ENV=prod iex -S mix phx.server
</code></pre>
<p>You can check the logs with <code>journalctl -xefu curse_of_myrra</code>.
From now on, you can just use: </p>
<pre><code class="language-sh">MIX_ENV=prod iex -S mix phx.server
</code></pre>
<ol start="4">
<li>Make sure to disable hyperthreading, if using an x86 CPU:</li>
</ol>
<pre><code class="language-sh"># If active, this returns 1
cat /sys/devices/system/cpu/smt/active
# Turn off hyperthreading
echo off | sudo tee /sys/devices/system/cpu/smt/control
</code></pre>
<p>One way of checking this, besides the command above,
is to open htop, you should see the virtual cores as 'offline'.</p>
<h3 id="load-test-client-setup"><a class="header" href="#load-test-client-setup">Load Test Client setup</a></h3>
<ol>
<li>Log into it with ssh: 
<pre><code class="language-sh">ssh myuser@myrra_load_test_client
</code></pre>
</li>
<li>If not already there, copy this repo's script under <code>server/load_test/setup_load_client.sh</code>
and run it:
<pre><code class="language-sh">scp /path_go_game_backend/game_backend/load_test/setup_load_client.sh myrra_load_test_server:/user/setup_load_client.sh
</code></pre>
<code>setup_load_client</code> can also take a branch name as an argument. So if you want to run the load test client from a specific branch, you can instead do:
<pre><code class="language-sh">./setup_load_client.sh &lt;BRANCH_NAME_TO_TEST&gt;
</code></pre>
</li>
<li>Set this env variable: <code>export SERVER_HOST=game_server_ip:game_server_port</code>.
Where <code>game_server_ip</code> is the ip of the load test server, and <code>game_server_port</code>,
the corresponding port.</li>
<li>Run:
<pre><code class="language-sh">    cd ./curse_of_myrra/server/load_test/ &amp;&amp; iex -S mix 
</code></pre>
this drops you into an Elixir shell from which you'll run the load tests.</li>
<li>From the elixir shell, start the load test with:
<pre><code class="language-elixir">LoadTest.PlayerSupervisor.spawn_players(number_of_players, play_time_in_seconds)
</code></pre>
</li>
</ol>
<h3 id="useful-tools"><a class="header" href="#useful-tools">Useful tools</a></h3>
<ul>
<li>Htop: To monitor CPU Usage, usually installed on Linux distributions and Mac.</li>
<li>Glances: Like htop but more friendly and has some more useful data,
like Net Usage.</li>
<li>Fprof: To generate a visual tree of function calls,
(here's how to use it)[https://blog.appsignal.com/2022/04/26/using-profiling-in-elixir-to-improve-performance.html],
you'll then (erlgrind)[https://github.com/isacssouza/erlgrind] to interpret the data,
and install (qcachegrind)[https://formulae.brew.sh/formula/qcachegrind].</li>
<li>Etop: Like unix's htop, but for erlang, on an Elixir Shell start it with:</li>
</ul>
<pre><code class="language-elixir">    Etop.start(file: &quot;/tmp/etop.exs&quot;, interval: 2000)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="simulating-high-latencynetwork-failures"><a class="header" href="#simulating-high-latencynetwork-failures">Simulating High Latency/Network Failures</a></h1>
<p>The backend can be configured to point to <a href="https://github.com/Shopify/toxiproxy">ToxiProxy</a>, which is a server that can act as a proxy between the client and the backend, allowing you to add network latency and simulate poor network environments in general.</p>
<p>To install ToxiProxy on `macOS``:</p>
<pre><code>brew tap shopify/shopify
brew install toxiproxy
</code></pre>
<p>To use it, do the following:</p>
<ul>
<li>
<p>Start a <code>toxiproxy</code> server with</p>
<pre><code>toxiproxy-server
</code></pre>
</li>
<li>
<p>Set the following environment variable before running the backend:</p>
<pre><code>USE_PROXY=true
</code></pre>
<p>This will make the backend setup the proxy on startup.</p>
</li>
<li>
<p>Edit the <code>GameSettings.json</code> file setting <code>use_proxy</code> to <code>&quot;true&quot;</code>.</p>
</li>
<li>
<p>Use the <code>toxiproxy</code> CLI to set the desired network conditions. As an example, if you want to add 300 ms of latency, run</p>
<pre><code>toxiproxy-cli toxic add -n latency -t latency -a latency=300 myrra_proxy
</code></pre>
<p>To update it to 500 ms:</p>
<pre><code>toxiproxy-cli toxic update -n latency -a latency=500 myrra_proxy
</code></pre>
<p>To continuosly change latency to simulate lag spikes, there's a small bash script on the root directory called <code>lag_spikes.sh</code> that will randomly set the latency to values in the range of <code>100-300</code> ms. With everything setup all you need to do is run</p>
<pre><code>./lag_spikes.sh
</code></pre>
<p>You should see your ping in-game varying wildy.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
